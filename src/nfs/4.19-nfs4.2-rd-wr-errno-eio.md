# 问题描述

NFS客户端采用NFSv4.2(vers=4.2)挂载时，tcpdump抓包发现，NFS服务端经常SEQUENCE 返回 NFS4ERR_BADSESSION错误导致 客户端主动DESTROY_SESSION和CREATE_SESSION，客户端创建会话时，服务端返回NFS4ERR_STATLE_CLIENTID错误，客户端需要重新EXCHANGE_ID后CREATE_SESSION才成功，因为反复出现这种现象，导致客户端读写文件会出现偶尔错误，系统errno 会返回5。客户端改成 NFSv4.0和NFSv4.1没有出现这种现象。client日志中打印了`NFS: nfs4_reclaim_open_state: Lock reclaim failed!`，server日志中打印了`NFSD: client xx.xx.xx.xx testing state ID with incorrect client ID`。

挂载参数:
```sh
(ro,noexec,relatime,vers=4.1,rsize=1048576,wsize=1048576,namlen=255,soft,proto=tcp,timeo=10,retrans=2,sec=sys,clientaddr=xx.xx.xx.xx,local_lock=none,addr=xx.xx.xx.xx)
(ro,noexec,relatime,vers=4.2,rsize=1048576,wsize=1048576,namlen=255,soft,proto=tcp,timeo=10,retrans=2,sec=sys,clientaddr=xx.xx.xx.xx,local_lock=none,addr=xx.xx.xx.xx)
```

# 分析

关于打印日志`NFS: nfs4_reclaim_open_state: Lock reclaim failed!`，请查看[`3e2910c7e23b NFS: Improve warning message when locks are lost.`](https://chenxiaosong.com/courses/nfs/patches/NFS-Improve-warning-message-when-locks-are-lost.html)，注意nfs4.0、4.1和4.2都会有这个打印。

关于打印`NFSD: client xx.xx.xx.xx testing state ID with incorrect client ID`已经被补丁`663e36f07666 nfsd4: kill warnings on testing stateids with mismatched clientids`移除。

# 尝试复现

```sh
mount -t nfs -o ro,noexec,relatime,vers=4.2,rsize=1048576,wsize=1048576,namlen=255,soft,proto=tcp,timeo=10,retrans=2,sec=sys,local_lock=none 192.168.53.214:s_test /mnt
```