CVE-2023-6610 修复补丁: [`567320c46a60a3c39b69aa1df802d753817a3f86 smb: client: fix potential OOB in smb2_dump_detail()`](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=567320c46a60a3c39b69aa1df802d753817a3f86)

因为主线代码文件夹经过了重命名`38c8a9a52082 smb: move client and server files to common directory fs/smb`，低版本要打上这个补丁，必须将`.patch`文件中的`smb/client`改成`cifs`:
```sh
sed -i 's/smb\/client/cifs/g' 0001-smb-client-fix-potential-OOB-in-smb2_dump_detail.patch
```

此修复补丁修复`smb2_dump_detail()->calc_smb_size()`的越界问题，调用`calc_smb_size()`之前要先用`check_message()`校验。

# 4.19合补丁

使用`git am 0001-smb-client-fix-potential-OOB-in-smb2_dump_detail.patch --reject`命令打上补丁后，会有冲突，不同的地方是:
```sh
diff --git a/fs/cifs/smb2misc.c b/fs/cifs/smb2misc.c
index 39ae3baa52a3..790e2e932e68 100644
--- a/fs/cifs/smb2misc.c
+++ b/fs/cifs/smb2misc.c
@@ -204,20 +204,20 @@ smb2_check_message(char *buf, unsigned int len, struct TCP_Server_Info *srvr)
                return 1;
 
        if (shdr->StructureSize != SMB2_HEADER_STRUCTURE_SIZE) {
-               cifs_dbg(VFS, "Illegal structure size %u\n",
+               cifs_dbg(VFS, "Invalid structure size %u\n",
                         le16_to_cpu(shdr->StructureSize));
                return 1;
        }
 
        command = le16_to_cpu(shdr->Command);
        if (command >= NUMBER_OF_SMB2_COMMANDS) {
-               cifs_dbg(VFS, "Illegal SMB2 command %d\n", command);
+               cifs_dbg(VFS, "Invalid SMB2 command %d\n", command);
                return 1;
        }
 
        if (smb2_rsp_struct_sizes[command] != pdu->StructureSize2) {
                if (command != SMB2_OPLOCK_BREAK_HE && (shdr->Status == 0 ||
-                   pdu->StructureSize2 != SMB2_ERROR_STRUCTURE_SIZE2)) {
+                   pdu->StructureSize2 != SMB2_ERROR_STRUCTURE_SIZE2_LE)) {
                        /* error packets have 9 byte structure size */
                        cifs_dbg(VFS, "Illegal response size %u for command %d\n",
                                 le16_to_cpu(pdu->StructureSize2), command);
diff --git a/fs/cifs/smb2ops.c b/fs/cifs/smb2ops.c
index 813d67b4a1a5..9f2c0733a4ae 100644
--- a/fs/cifs/smb2ops.c
+++ b/fs/cifs/smb2ops.c
@@ -245,9 +245,9 @@ smb2_dump_detail(void *buf, struct TCP_Server_Info *server)
 #ifdef CONFIG_CIFS_DEBUG2
        struct smb2_sync_hdr *shdr = (struct smb2_sync_hdr *)buf;
 
-       cifs_dbg(VFS, "Cmd: %d Err: 0x%x Flags: 0x%x Mid: %llu Pid: %d\n",
+       cifs_server_dbg(VFS, "Cmd: %d Err: 0x%x Flags: 0x%x Mid: %llu Pid: %d\n",
                 shdr->Command, shdr->Status, shdr->Flags, shdr->MessageId,
-                shdr->ProcessId);
+                shdr->Id.SyncId.ProcessId);
        cifs_dbg(VFS, "smb buf %p len %u\n", buf,
                 server->ops->calc_smb_size(buf, server));
 #endif
```

先看`fs/cifs/smb2ops.c`文件的冲突，在主线代码上使用`git blame fs/smb/client/smb2ops.c | grep "cifs_server_dbg"`找到前置补丁`3175eb9b577e cifs: add a debug macro that prints \\server\share for errors`，打上这个前置补丁有很多的冲突，而这里只是涉及到打印相关的，所以不合入此前置补丁，手动处理冲突。再使用`git blame fs/smb/client/smb2ops.c | grep "Id.SyncId.ProcessId"`找到前置补丁`0d35e382e4e9 cifs: Create a new shared file holding smb2 pdu definitions`，打上这个前置补丁也会有很多的冲突，也不涉及cve的修复内容，所以不合入这个前置补丁，也手动处理冲突。

再看`fs/cifs/smb2misc.c`文件的冲突，在主线代码上使用`git blame fs/smb/client/smb2misc.c | grep SMB2_ERROR_STRUCTURE_SIZE2_LE`找到前置补丁`113be37d8744 [smb3] move more common protocol header definitions to smbfs_common`，打上这个前置补丁会有很多冲突，也不涉及cve的修复内容，所以不合入此前置补丁，手动处理冲突。再切换到cve修复补丁的前一个commit，`git checkout aa3e193d66db56b3331142509acb4b5bad4e7f4f && git blame fs/smb/client/smb2misc.c | grep Invalid SMB2 command`找到前置补丁`a0a3036b81f1 cifs: Standardize logging output`，打上这个前置补丁有很多冲突，只涉及打印相关的，所以不合入这个前置补丁，手动处理冲突。

# 4.4合补丁

前置补丁有:

- `93012bf98416 cifs: add server->vals->header_preamble_size`: `9ec672bd1713`的前置补丁，用`header_preamble_size`变量取代常数4
- `c0953f2ed510 cifs: smb2pdu: Fix potential NULL pointer dereference`: 修复`93012bf98416`导致的空指针解引用
- `14547f7d74c4 cifs: add server argument to the dump_detail method`: 给函数`smb2_dump_detail()`增加一个参数
- `9ec672bd1713 cifs: update calc_size to take a server argument`: 给`calc_size()`相关的函数增加一个参数，另外用`heder_preamble_size`变量取代常数4
- `71992e62b864 cifs: fix build break when CONFIG_CIFS_DEBUG2 enabled`: 修复编译错误, `dump_detail()`和`calc_smb_size()`增加参数，要把`CONFIG_CIFS_DEBUG2`配置打开测试才会出现，麒麟的配置默认不打开
